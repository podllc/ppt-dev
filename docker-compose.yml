services:
  # ============================================================================
  # SHARED INFRASTRUCTURE
  # ============================================================================

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: ppt-sqlserver
    platform: linux/amd64
    environment:
      ACCEPT_EULA: ${ACCEPT_EULA:-Y}
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD}
      MSSQL_PID: ${MSSQL_PID:-Developer}
    volumes:
      - sqlserver_data:/var/opt/mssql
    ports:
      - "1433:1433"
    networks:
      - ppt-internal
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P ${MSSQL_SA_PASSWORD} -C -Q 'SELECT 1' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7-alpine
    container_name: ppt-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - ppt-internal
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    container_name: ppt-azurite
    command: azurite --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0
    volumes:
      - azurite_data:/data
    ports:
      - "10000:10000"  # Blob
      - "10001:10001"  # Queue
      - "10002:10002"  # Table
    networks:
      - ppt-internal
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "10000"]
      interval: 10s
      timeout: 5s
      retries: 5

  sonarqube-mcp:
    image: mcp/sonarqube:latest
    container_name: ppt-sonarqube-mcp
    environment:
      - SONARQUBE_TOKEN=${SONAR_TOKEN}
      - SONARQUBE_URL=${SONARQUBE_URL:-https://sonarqube.rnd.ontherapy.dev}
      - SONARQUBE_TRANSPORT=http
      - SONARQUBE_HTTP_PORT=8080
      - SONARQUBE_HTTP_HOST=0.0.0.0
    ports:
      - "8090:8080"
    networks:
      - ppt-internal
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================================================
  # DEVELOPMENT CONTAINERS
  # ============================================================================
  # Repositories are cloned to ./repos/ via clone-repos.sh
  # ============================================================================

  microservice-epa:
    container_name: ppt-microservice-epa
    user: ${CONTAINER_USERNAME}
    build:
      context: .
      dockerfile: Dockerfile
      target: dotnet
      args:
        USERNAME: ${CONTAINER_USERNAME}
    volumes:
      - ./repos/microservice-epa:/workspace:cached
      - ./.devcache/microservice-epa:/home/${CONTAINER_USERNAME}:cached
      - ./.devcache/claude-shared:/home/claude-shared:cached
      - ./.devcache/gh-shared:/home/gh-shared:cached
    env_file:
      - .env
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://0.0.0.0:5000
    ports:
      - "5100:5000"
    networks:
      - ppt-internal
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
    working_dir: /workspace
    command: /bin/sh -c "while sleep 1000; do :; done"

  microservice-case-management:
    container_name: ppt-microservice-case-management
    user: ${CONTAINER_USERNAME}
    build:
      context: .
      dockerfile: Dockerfile
      target: dotnet
      args:
        USERNAME: ${CONTAINER_USERNAME}
    volumes:
      - ./repos/microservice-case-management:/workspace:cached
      - ./.devcache/microservice-case-management:/home/${CONTAINER_USERNAME}:cached
      - ./.devcache/claude-shared:/home/claude-shared:cached
      - ./.devcache/gh-shared:/home/gh-shared:cached
    env_file:
      - .env
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://0.0.0.0:5000
    ports:
      - "5200:5000"
    networks:
      - ppt-internal
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
    working_dir: /workspace
    command: /bin/sh -c "while sleep 1000; do :; done"

  microservice-profile:
    container_name: ppt-microservice-profile
    user: ${CONTAINER_USERNAME}
    build:
      context: .
      dockerfile: Dockerfile
      target: dotnet
      args:
        USERNAME: ${CONTAINER_USERNAME}
    volumes:
      - ./repos/microservice-profile:/workspace:cached
      - ./.devcache/microservice-profile:/home/${CONTAINER_USERNAME}:cached
      - ./.devcache/claude-shared:/home/claude-shared:cached
      - ./.devcache/gh-shared:/home/gh-shared:cached
    env_file:
      - .env
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://0.0.0.0:5000
    ports:
      - "5250:5000"
    networks:
      - ppt-internal
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
    working_dir: /workspace
    command: /bin/sh -c "while sleep 1000; do :; done"

  microservice-sam-gateway:
    container_name: ppt-microservice-sam-gateway
    user: ${CONTAINER_USERNAME}
    build:
      context: .
      dockerfile: Dockerfile
      target: dotnet
      args:
        USERNAME: ${CONTAINER_USERNAME}
    volumes:
      - ./repos/microservice-sam-gateway:/workspace:cached
      - ./.devcache/microservice-sam-gateway:/home/${CONTAINER_USERNAME}:cached
      - ./.devcache/claude-shared:/home/claude-shared:cached
      - ./.devcache/gh-shared:/home/gh-shared:cached
    env_file:
      - .env
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://0.0.0.0:5000
    ports:
      - "5300:5000"
    networks:
      - ppt-internal
    depends_on:
      redis:
        condition: service_healthy
    working_dir: /workspace
    command: /bin/sh -c "while sleep 1000; do :; done"

  ppt-agentic:
    container_name: ppt-agentic
    user: ${CONTAINER_USERNAME}
    build:
      context: .
      dockerfile: Dockerfile
      target: dotnet
      args:
        USERNAME: ${CONTAINER_USERNAME}
    volumes:
      - ./repos/ppt-agentic:/workspace:cached
      - ./.devcache/ppt-agentic:/home/${CONTAINER_USERNAME}:cached
      - ./.devcache/claude-shared:/home/claude-shared:cached
      - ./.devcache/gh-shared:/home/gh-shared:cached
    env_file:
      - .env
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://0.0.0.0:5000
    ports:
      - "5400:5000"
    networks:
      - ppt-internal
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
    working_dir: /workspace
    command: /bin/sh -c "while sleep 1000; do :; done"

  ppt-common-csharp:
    container_name: ppt-common-csharp
    user: ${CONTAINER_USERNAME}
    build:
      context: .
      dockerfile: Dockerfile
      target: dotnet
      args:
        USERNAME: ${CONTAINER_USERNAME}
    volumes:
      - ./repos/ppt-common-csharp:/workspace:cached
      - ./.devcache/ppt-common-csharp:/home/${CONTAINER_USERNAME}:cached
      - ./.devcache/claude-shared:/home/claude-shared:cached
      - ./.devcache/gh-shared:/home/gh-shared:cached
    env_file:
      - .env
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
    ports:
      - "5500:5000"
    networks:
      - ppt-internal
    working_dir: /workspace
    command: /bin/sh -c "while sleep 1000; do :; done"

  ppt-dev:
    container_name: ppt-dev
    hostname: ppt-dev
    user: ${CONTAINER_USERNAME}
    build:
      context: .
      dockerfile: Dockerfile
      target: dotnet
      args:
        USERNAME: ${CONTAINER_USERNAME}
    volumes:
      - .:/workspace:cached
      - ./.devcache/ppt-dev:/home/${CONTAINER_USERNAME}:cached
      - ./.devcache/claude-shared:/home/claude-shared:cached
      - ./.devcache/gh-shared:/home/gh-shared:cached
    env_file:
      - .env
    ports:
      - "5600:5000"
    networks:
      - ppt-internal
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
    working_dir: /workspace/repos
    stdin_open: true
    tty: true
    command: /bin/sh -c "while sleep 1000; do :; done"

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  sqlserver_data:
    name: ppt-sqlserver-data
  redis_data:
    name: ppt-redis-data
  azurite_data:
    name: ppt-azurite-data

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  ppt-internal:
    driver: bridge
